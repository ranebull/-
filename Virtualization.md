# Курс лекций по виртуализации
### Первое занятие
### Что же такое виртуализация?
**Виртуализация** – это абстрактное предоставление ресурсов.

Причем, неважно, что за устройство предоставляет эти ресурсы – CPU, GPU, RAM, сети и т.д.  

Сам термин «виртуализация» в компьютерных технологиях появился в шестидесятых годах прошлого века вместе с термином «виртуальная машина»,
означающим продукт виртуализации программно-аппаратной платформы. В то время виртуализация была, скорее, интересной технической находкой,
чем перспективной технологией.  

Разработки в сфере виртуализации в шестидесятых-семидесятых годах проводились только компанией IBM.
С появлением в компьютере IBM M44/44X экспериментальной системы пэйджинга, впервые был употреблен термин
«виртуальная машина» (virtual machine),который заменил более ранний термин «псевдо машина» (pseudo machine). 
Затем в мэйнфреймах IBM серии System 360/370, можно было использовать виртуальные машины для сохранения
предыдущих версий операционных систем.  

До конца девяностых годов никто кроме IBM так и не решался использовать
эту оригинальную технологию всерьез. Однако в девяностых годах стали очевидны перспективы подхода виртуализации:
с ростом аппаратных мощностей, как персональных компьютеров, так и серверных решений,
вскоре представится возможность использовать несколько виртуальных машин на одной физической платформе.  

В данный момент от старых мейнфреймов стараются избавиться, консолидируя их в европейской части
(если у компании имеется такая возможность). Причин несколько – возраст у большинства мейнфреймов уже солидный,
а обслуживание дорого (для починки мейфрейма нужно обращаться в поддержку вендора, а это выходит в сумму
в несколько сотен или тысяч долларов).  

В дополнение к этому, в европейской части проще найти людей, 
которые всё ещё могут писать на COBOL – специалистов всё меньше и меньше, и большая часть из них уже пенсионеры. 
Новые же модели мейнфреймов от IBM из линейки LinuxOne – Emperor и Rockchopper – позволяют использовать Linux,
а значит использовать больше решений виртуализации и контейнеризации.  

В 1997 году компания Connectix выпускает первую версию Virtual PC для платформы Macintosh,
а в 1998 году VMware патентует свои техники виртуализации. Компания Connectix впоследствии была куплена корпорацией Microsoft,
а VMware корпорацией EMC, и на данный момент обе эти компании являются двумя основными потенциальными конкурентами на
рынке технологий виртуализации в будущем. Потенциальными — потому что сейчас VMware безоговорочный лидер на этом рынке,
однако у Microsoft, как всегда, есть козырь в рукаве.

### Виды виртуализации
Понятие виртуализации условно можно разделить на две фундаментально различающиеся категории:  
* **виртуализация платформ**  
Продуктом этого вида виртуализации являются виртуальные машины — некие программные абстракции, запускаемые на платформе реальных аппаратно-программных систем.
* **виртуализация ресурсов**  
Данный вид виртуализации преследует своей целью комбинирование или упрощение представления аппаратных ресурсов для пользователя и получение неких пользовательских абстракций оборудования, пространств имен, сетей и т.п.  


![test](http://www.ixbt.com/cm/images/virtualization/virtualization600.jpg)

### Виртуализация платформ
Под виртуализацией платформ понимают создание программных систем на основе существующих аппаратно-программных комплексов, зависящих или независящих от них. Система, предоставляющая аппаратные ресурсы и программное обеспечение, называется хостовой (host), а симулируемые ей системы — гостевыми (guest).    

Чтобы гостевые системы могли стабильно функционировать на платформе хостовой системы, необходимо, чтобы программное и аппаратное обеспечение хоста было достаточно надежным и предоставляло необходимый набор интерфейсов для доступа к его ресурсам. Есть несколько видов виртуализации платформ, в каждом из которых осуществляется свой подход к понятию «виртуализация». Виды виртуализации платформ зависят от того, насколько полно осуществляется симуляция аппаратного обеспечения.  

До сих пор нет единого соглашения о терминах в сфере виртуализации, поэтому некоторые из 
приведенных далее видов виртуализации могут отличаться от тех, что предоставят другие источники.  
####Виды виртуализации платформ
1. **Полная эмуляция (симуляция).**  
При таком виде виртуализации виртуальная машина полностью эмулирует все аппаратное обеспечение определенной платформы. Такой подход позволяет эмулировать различные аппаратные архитектуры.   
Например, можно запускать виртуальные машины с гостевыми системами для x86-процессоров на платформах с другой архитектурой (например, на RISC- серверах компании Sun). Долгое время такой вид виртуализации использовался, чтобы разрабатывать программное обеспечение для новых процессоров еще до того, как они были физически доступными.  
Такие эмуляторы также применяют для низкоуровневой отладки операционных систем. Основной минус данного подхода заключается в том, что эмулируемое аппаратное обеспечение весьма и весьма существенно замедляет быстродействие гостевой системы, что делает работу с ней очень неудобной, поэтому, кроме как для разработки системного программного обеспечения, а также образовательных целей, такой подход мало где используется.  
Примеры продуктов для создания эмуляторов: Bochs, PearPC, QEMU (без ускорения), Hercules Emulator.  
2. **Частичная эмуляция (нативная виртуализация).**
Частичная виртуализация базируется на принципе эмуляции только необходимого количества ресурсов, чтобы виртуальная машина могла быть запущена изолировано. Такой подход позволяет запускать гостевые операционные системы, разработанные только для той же архитектуры, что и у хоста.  
Таким образом, несколько экземпляров гостевых систем могут быть запущены одновременно. Этот вид виртуализации позволяет существенно увеличить быстродействие гостевых систем по сравнению с полной эмуляцией и широко используется в настоящее время. В целях повышения быстродействия в платформах виртуализации, использующих данный подход, применяется специальная «прослойка» между гостевой операционной системой и оборудованием (гипервизор), позволяющая гостевой системе напрямую обращаться к ресурсам аппаратного обеспечения. 
Гипервизор, называемый также «Монитор виртуальных машин» (Virtual Machine Monitor) — одно из ключевых понятий в мире виртуализации. Применение гипервизора, являющегося связующим звеном между гостевыми системами и аппаратурой, существенно увеличивает быстродействие платформы, приближая его к быстродействию физической платформы. К минусам данного вида виртуализации можно отнести зависимость виртуальных машин от архитектуры аппаратной платформы.  
Примеры продуктов для нативной виртуализации: VMware Workstation, VMware Server, VMware ESX Server, Virtual Iron, Virtual PC, VirtualBox, Parallels Desktop и другие. 
3. **Частичная виртуализация, а также «виртуализация адресного пространства» («address space virtualization»).**
Подход частичной виртуализации заключается в симулировании нескольких экземпляров аппаратного обеспечения (особенно часто используется виртуализация адресного пространства). Это позволяет совместно использовать ресурсы и изолировать процессы, но не позволяет создавать экземпляры гостевых систем.  
Строго говоря, при таком виде виртуализации пользователем не создаются виртуальные машины, а происходит изоляция каких-либо процессов на уровне операционной системы. В данный момент многие из известных операционных систем используют такой подход. Примером может послужить использование UML (User-mode Linux), в котором «гостевое» ядро запускается в пользовательском пространстве базового ядра (в его контексте).  
4. **Паравиртуализация.**
Метод паравиртуализации не вынуждает эмулировать аппаратное обеспечение, однако требует от гостевой системы наличия специального программного интерфейса для взаимодействия с хостовой системой. Такой подход требует модификации кода гостевой системы, что, с точки зрения сообщества, Open Source не так и критично.  
Системы для паравиртуализации также имеют свой гипервизор, а API-вызовы к гостевой системе, называются «hypercalls» (гипервызовы). Многие сомневаются в перспективах этого подхода виртуализации, поскольку в данный момент все решения производителей аппаратного обеспечения в отношении виртуализации направлены на системы с нативной виртуализацией, а поддержку паравиртуализации приходится искать у производителей операционных систем, которые слабо верят в возможности предлагаемого им средства.  
В настоящее время провайдерами паравиртуализации являются компании XenSource и Virtual Iron, утверждающие, что быстродействие паравиртуализации выше. 
5. **Виртуализация уровня операционной системы.**
Данный метод позволяет в рамках одной операционной системы выделить ресурсы для выполнения независимых гостевых операционных систем.  Каждая гостевая система имеет изолированную от хостовой системы среду выполнения, что обеспечивает достаточную безопасность.   
Сутью данного вида виртуализации является виртуализация физического сервера на уровне операционной системы в целях создания нескольких защищенных виртуализованных серверов на одном физическом.   
Гостевая система, в данном случае, разделяет использование одного ядра хостовой операционной системы с другими гостевыми системами. Виртуальная машина представляет собой окружение для приложений, запускаемых изолированно. Данный тип виртуализации применяется при организации систем хостинга, когда в рамках одного экземпляра ядра требуется поддерживать несколько виртуальных серверов клиентов.  
Примеры виртуализации уровня ОС: Linux-VServer, Virtuozzo, OpenVZ, Solaris Containers и FreeBSD Jails. 
6. **Виртуализация уровня приложений.**
Виртуализация приложений значительно отличается от всех остальных видов виртуализации. Целевое приложение (а не вся операционная система) помещается в специальный контейнер, который эмулирует работу операционной системы с данным приложением. Контейнер содержит все необходимые приложению ресурсы: системные файлы, файлы реестра и конфигурационные файлы.  
Этот вид виртуализации не похож на все остальные: если в предыдущих случаях создаются виртуальные среды или виртуальные машины, использующиеся для изоляции приложений, то в данном случае само приложение помещается в контейнер с необходимыми элементами для своей работы: файлами реестра, конфигурационными файлами, пользовательскими и системными объектами. В результате получается приложение, не требующее установки на аналогичной платформе.  
При переносе такого приложения на другую машину и его запуске, виртуальное окружение, созданное для программы, разрешает конфликты между ней и операционной системой, а также другими приложениями. Такой способ виртуализации похож на поведение интерпретаторов различных языков программирования (недаром интерпретатор, Виртуальная Машина Java (JVM), тоже попадает в эту категорию).  
Примером такого подхода служат: Thinstall, Altiris, Trigence, Softricity. 

### Виртуализация ресурсов
При описании виртуализации платформ мы рассматривали понятие виртуализации в узком смысле, преимущественно применяя его к процессу создания виртуальных машин. Однако если рассматривать виртуализацию в широком смысле, можно прийти к понятию виртуализации ресурсов, обобщающим в себе подходы к созданию виртуальных систем.  

Виртуализация ресурсов позволяет концентрировать, абстрагировать и упрощать управление группами ресурсов, таких как сети, хранилища данных и пространства имен.
### Виды виртуализации ресурсов
1. Объединение, агрегация и концентрация компонентов.  
Под таким видом виртуализации ресурсов понимается организация нескольких физических или логических объектов в пулы ресурсов 
(группы), представляющих удобные интерфейсы пользователю.
Примеры такого вида виртуализации:
  * многопроцессорные системы, представляющиеся нам как одна мощная система,
  * RAID-массивы и средства управления томами, комбинирующие несколько физических дисков в один логический,
  * виртуализация систем хранения, используемая при построении сетей хранения данных SAN (Storage Area Network), 
  * виртуальные частные сети (VPN) и трансляция сетевых адресов (NAT), позволяющие создавать виртуальные пространства сетевых адресов и имен.  
2. Кластеризация компьютеров и распределенные вычисления (grid computing).  
Этот вид виртуализации включает в себя техники, применяемые при объединении множества отдельных компьютеров в глобальные системы (метакомпьютеры), совместно решающие общую задачу. 
3. Разделение ресурсов (partitioning).  
При разделении ресурсов в процессе виртуализации происходит разделение какого-либо одного большого ресурса на несколько однотипных объектов, удобных для использования. В сетях хранения данных это называется зонированием ресурсов («zoning»).
4. Инкапсуляция.  
Инкапсуляция - сокрытие объектом внутри себя своей реализации. Применительно к виртуализации, можно сказать, что это процесс создания системы, предоставляющей пользователю удобный интерфейс для работы с ней и скрывающей подробности сложности своей реализации.   Например, использование центральным процессором кэша для ускорения вычислений не отражается на его внешних интерфейсах.  
Виртуализация ресурсов, в отличие от виртуализации платформ, имеет более широкий и расплывчатый смысл и представляет собой массу различных подходов, направленных на повышение удобства обращения пользователей с системами в целом.  
Поэтому, далее мы будем опираться в основном на понятие виртуализации платформ, поскольку технологии, связанные именно с этим понятием, являются в данный момент наиболее динамично развивающимися и эффективными.  
 
### Применение виртуализации
* Консолидация серверов. 
* Разработка и тестирование приложений. 
* Использование в бизнесе. 
* Использование виртуальных рабочих станций.  

### Гипервизоры
**Гипервизор** – один из основных способов виртуализировать вычислительную среду. Одна из ключевых функций гипервизоров – изоляция. Это означает, что гостевая ОС не может влиять на работу хостовой ОС, даже если она упадет с критичной ошибкой или зависнет.  
Гипервизор должен тщательно виртуализировать нужные аппаратные компоненты платформы, предотвращая доступ гостевой машины к хостовой.    
Гипервизоры делятся на 2 типа – 1 типа и 2 типа. Гипервизор 1 типа (иногда называется гипервизором «на голом железе» – Bare Metal) работает непосредственно на физическом оборудовании. Каждый гостевая ОС запущена поверх гипервизора. Xen – канонический пример такого гипервизора. Один или более гостевых систем могут быть обозначены, как особые (в Xen это называется dom-0) и имеют возможность привилегированного контроля над гипервизором.  

Гипервизор 2 типа (иногда называемый гипервизором над ОС – Hosted hypervisor) запускается внутри ОС, которая в свою очередь запущена на каком- либо железе. Каждая гостевая ОС запущена поверх гипервизора. Основное отличие, почему гипервизор 1 типа лучше гипервизора 2 типа в том, что в 1 типе отсутствует оверхед, который происходит при доступе хостовой ОС к физическим ресурсам.  

Сравнение выглядит довольно простым. Например, на первый взгляд, KVM, запущенный в виде процесса на хостовом Linux-дистрибутиве¬, представляет собой гипервизор 2 типа. Но это несколько не так – процесс запущен, но дает доступ ограниченному числу ресурсов ОС, а самые высокопроизводительные задачи выполняются модулем ядра, который имеет прямой доступ к аппаратным ресурсам.  

Hyper-V часто воспринимают как гипервизор 2 типа, потому что он управляется через графический интерфейс Windows. В действительности, гипервизор грузится до хостовой ОС.  

Еще одна неточность заключается в том, что термин «голое железо» часто используется для обозначения гипервизора который загружается (с или без небольшой встроенной хостовой ОС и является технически гипервизором 1 типа) без установки на существующей платформе, как готовое решение. В этом контексте VMware описывает ESXi как гипервизор 1 типа.

### SDN и libvirt
**Программно-определяемая сеть или программно-конфигурируемая
сеть (SDN, software-defined networking)** — сеть передачи данных, в которой
уровень управления сетью отделён от устройств передачи данных и
реализуется программно. Одна из форм виртуализации сети.  

Ключевые принципы программно-определяемых сетей — разделение
процессов передачи и управления данными, централизация управления сетью
при помощи унифицированных программных средств, виртуализация
физических  сетевых  ресурсов.  Протокол  OpenFlow,  реализующий
независимый от производителя интерфейс между логическим контроллером
сети и сетевым транспортом, является одной из реализаций концепции
программно-определяемой  сети  и  считается  движущей  силой  её
распространения и популяризации.  

**libvirt** — свободная, кроссплатформенная библиотека управления
виртуализацией. Библиотека для управления виртуализацией, реализующая интерфейс на
языках C/C++, Python, Ruby. Входит в состав большинства дистрибутивов
Linux и является основой для создания оболочек с Web-интерфейсом,
например oVirt.  

Позволяет управлять гипервизорами Xen, KVM, а также
VirtualBox, OpenVZ, LXC, VMware ESX/GSX/Workstation/Player, QEMU.
Позволяет контролировать по сети виртуальные машины, расположенные на
других компьютерах. Совместно с libvirt используется менеджер виртуальных
машин virt-manager, предоставляющий графический и консольный интерфейс
для создания, контроля состояния виртуальных машин (средства virt-viewer,
virt-manager).  

В состав libvirt входит сервис libvirtd и консольный инструмент virsh.  

**Поддерживаемые гипервизоры:**
* LXC — система контейнеров Linux
* OpenVZ — система контейнеров Linux
* Kernel-based Virtual Machine/QEMU (KVM) — гипервизор и
эмулятор
* Xen — гипервизор
* User-mode Linux (UML) — паравиртуализованное ядро
* VirtualBox — гипервизор
* VMware ESX, VMware GSX — гипервизоры
*	VMware Workstation, VMware Player — гипервизоры
*	Hyper-V — гипервизор от Microsoft
*	PowerVM — гипервизор от IBM
*	Parallels Workstation — гипервизор
*	BHyVe — гипервизор FreeBSD  

![libvirt](https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Libvirt_support.svg/1000px-Libvirt_support.svg.png)

### Экспериментальная система пейджинга (paging)
Когда программа выбрана для исполнения, система переносит её в виртуальную память (**virtual storage**) и разбивает её на страницы размером 4096 байт (4 КБ), а затем переносит страницы в центральную память (**central storage**) для исполнения. С точки зрения программиста вся программа занимает непрерывное пространство (представляет собой единое целое) в памяти во время исполнения. На самом деле не все страницы программы необходимо хранить в центральной памяти и не обязательно страницы должны представлять собой единое целое.  

Части программы, исполняемой в виртуальной памяти, перемещаются между физической и вспомогательной памятью. Для этого z/OS оперирует памятью, используя юниты или блоки размером 4 КБ. Некоторые блоки имеют определения:
*	блок центральной памяти – фрейм (**frame**);
*	блок виртуальной памяти – страница (**page**);
*	блок вспомогательной памяти – слот (**slot**);  

Страница, фрейм и слот имеют одинаковый размер – 4 КБ. Активная страница виртуальной памяти находится во фрейме центральной памяти. Страница виртуальной памяти, которая становится неактивной (бездействующей) находится в слоте вспомогательной памяти (подкачке). Рисунок показывает взаимосвязь 3 блоков памяти.  
![Paging](https://www.ibm.com/support/knowledgecenter/en/zosbasics/com.ibm.zos.zconcepts/zOSB035.gif)  

На рисунке z/OS производит подкачку для программы, запущенной в виртуальной памяти. Буквы показывают части программы. Части A, E, F и H активны и запущены в центральной памяти в виде кадров, в то время как части B, C, D и G неактивны и перемещены в слоты вспомогательной памяти. Все части программы расположены в виртуальной памяти и имеют адреса виртуальной памяти. z/OS использует набор таблиц для определения принадлежности блоков к виртуальной или вспомогательной памяти и их расположение.  

Чтобы найти страницу программы, z/OS проверяет таблицу виртуальных адресов, а не просматривает всю физическую память. z/OS переносит страницу из виртуальной памяти или во вспомогательную память, когда это необходимо. Перемещение страниц между слотами вспомогательной памяти и кадрами центральной памяти называется подкачкой. Подкачка – ключ к пониманию использования виртуальной памяти в z/OS.  

Подкачка в z/OS прозрачна для пользователя. Во время исполнения задания, только необходимые части программы переносятся или подкачиваются в центральную память. Страницы остаются в центральной памяти до тех пор, пока они необходимы, или до тех пор, пока другая страница используются тем же приложением или приложением с высоким приоритетом и пока в центральной памяти есть свободное место.  

Выбранные страницы подкачиваются во вспомогательную память – для z/OS использует алгоритм «Least Used» (наименее используемые страницы). То есть z/OS предполагает, что страница, которая не использовалась в течение некоторого времени, вероятно, не будет использоваться в ближайшем будущем.
